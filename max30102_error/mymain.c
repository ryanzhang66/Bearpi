#include <stdio.h>
#include <unistd.h>
#include "ohos_init.h"
#include "iot_watchdog.h"
#include "cmsis_os2.h"
#include "hi_gpio.h"

#include "i2c.h"
#include "max30102.h" 
#include "algorithm.h"

#include "myiic.h"

int max3012_interrupt(void)
{
	int val = {0};

    hi_gpio_get_input_val(PIN_INT, &val);

	return val;
}

#define MAX30102_INT max3012_interrupt()
                 

uint32_t aun_ir_buffer[500];   //IR LED sensor data
int32_t n_ir_buffer_length=500;    //data length
uint32_t aun_red_buffer[500];  //Red LED sensor data
int32_t n_sp02; //SPO2 value
int8_t ch_spo2_valid;   //indicator to show if the SP02 calculation is valid
int32_t n_heart_rate;   //heart rate value
int8_t  ch_hr_valid;
uint32_t  i=0,k=0;
uint32_t aun_ir_buffer11[500]={0x17292,0x17278,0x17284,0x17285,0x17287,0x17286,0x17283,0x17290,0x17290,0x17293,0x172a2,0x17297,0x1729c,0x17299,0x1729f,0x17293,0x17299,0x172a8,0x172a3,0x1729e,0x1729b,0x1729e,0x172a3,0x1729a,0x172a2,0x1729f,0x172ae,0x1729e,0x172ae,0x172af,0x172a3,0x172ac,0x10d4,0x10e4,0x1117,0x1142,0x1171,0x117c,0x117f,0x115e,0x1134,0x1111,0x10e9,0x10d6,0x10c4,0x10af,0x1091,0x106b,0x104b,0x102f,0x1031,0x1039,0x1044,0x1043,0x1036,0x1032,0x1027,0x102b,0x101f,0x101c,0x102a,0x1040,0x1068,0x107a,0x10a6,0x10c5,0x10fb,0x1132,0x1172,0x11a4,0x11ca,0x11e4,0x1211,0x124c,0x129d,0x12f8,0x1344,0x138d,0x13e4,0x1430,0x145a,0x149d,0x14e8,0x1513,0x154e,0x1565,0x1581,0x15a8,0x15de,0x15f1,0x1625,0x1656,0x16c8,0x1731,0x17a1,0x17de,0x1815,0x181b,0x1822,0x182d,0x1848,0x1857,0x1876,0x1878,0x1872,0x188d,0x18db,0x193a,0x1999,0x19e5,0x1a0c,0x1a2c,0x1a4e,0x1a91,0x1afd,0x1b72,0x1bdd,0x1c24,0x1c5d,0x1ca1,0x1cb9,0x1cab,0x1bf2,0x1b51,0x1a41,0x1a6f,0x1c03,0x1e11,0x2090,0x23d8,0x2738,0x2c26,0x8b8,0x925,0x9be,0xaa4,0xbc7,0xd1c,0xea2,0x102f,0x11fd,0x1401,0x1689,0x1958,0x1c8a,0x203a,0x24a2,0x2a03,0x30c4,0x396a,0x4430,0x50e9,0x5f67,0x6f65,0x815f,0x95d1,0xadd6,0xc9ec,0xeb94,0x11382,0x1414a,0x173f7,0x1a19f,0x1d825,0x1fcc1,0x20725,0x1df15,0x182e5,0x1659b,0x1663f,0x16652,0x1666e,0x16693,0x16661,0x1661f,0x1662f,0x1663f,0x16628,0x16624,0x16642,0x166a0,0x16703,0x1673a,0x1675a,0x16763,0x16779,0x167ae,0x167d2,0x16838,0x168ab,0x1690b,0x1696e,0x169b1,0x169fb,0x16a4a,0x16a9e,0x16afe,0x16b3b,0x16b98,0x16be0,0x16c38,0x16ca5,0x16cf6,0x16d52,0x16dac,0x16e16,0x16e97,0x16ee2,0x16f2e,0x16f51,0x16f81,0x16f82,0x16f7d,0x16f8c,0x16f98,0x16f8a,0x16f9f,0x16fa1,0x16fd1,0x16fed,0x17007,0x17047,0x17089,0x170dc,0x17123,0x17166,0x17192,0x171d1,0x171e9,0x1720a,0x1722f,0x17241,0x175bc,0x175b5,0x175c2,0x175b2,0x175b4,0x175ac,0x175b7,0x1759e,0x175ad,0x175a0,0x175aa,0x175b1,0x17596,0x17592,0x17598,0x17595,0x1759c,0x17599,0x1758f,0x17597,0x17587,0x17591,0x17595,0x17586,0x17588,0x17594,0x17596,0x1759c,0x1759e,0x1759e,0x175ab,0x175aa,0x175b0,0x175b0,0x175b2,0x175bc,0x175b8,0x175ae,0x175a9,0x175b5,0x175ae,0x175c2,0x175c0,0x175b4,0x175b9,0x175c5,0x175b4,0x175bb,0x175ba,0x175b2,0x175bc,0x175b1,0x175b6,0x175ae,0x175c0,0x175bd,0x175ad,0x175c1,0x175c1,0x175b3,0x175b6,0x175c8,0x175be,0x175c6,0x175c7,0x175c7,0x175c8,0x175cb,0x175c9,0x175c5,0x175d6,0x175d9,0x175d0,0x175d0,0x175d3,0x175da,0x175d6,0x175da,0x175d5,0x175d9,0x175d7,0x175d7,0x175d3,0x175de,0x175e8,0x175d9,0x175d2,0x175d6,0x175d9,0x175cb,0x175e4,0x175da,0x175eb,0x175ed,0x175e8,0x175e1,0x175e4,0x175d3,0x175d7,0x175d9,0x17643,0x1765a,0x17658,0x17655,0x17663,0x17657,0x17668,0x1764c,0x1765a,0x17656,0x1765e,0x1765b,0x17663,0x17660,0x1765c,0x17667,0x17665,0x1766d,0x17667,0x1766d,0x1766f,0x17663,0x17663,0x17665,0x17674,0x1766b,0x17664,0x17660,0x1766c,0x17661,0x17672,0x1766a,0x1766c,0x1766d,0x17670,0x1766b,0x17670,0x17678,0x17677,0x17682,0x1767f,0x1767b,0x1767f,0x1767c,0x1767c,0x17672,0x17680,0x1767f,0x1768c,0x17684,0x1767d,0x1767e,0x1767f,0x17681,0x17680,0x17685,0x17684,0x17685,0x1768e,0x1768d,0x1768c,0x17687,0x1768f,0x17695,0x17691,0x1768f,0x1768b,0x17698,0x17693,0x1768a,0x1767e,0x17678,0x1766e,0x17673,0x1767c,0x17678,0x17685,0x1767e,0x1767f,0x17675,0x17672,0x17677,0x17672,0x17669,0x1766e,0x1767b,0x17689,0x17693,0x17689,0x17699,0x1768b,0x1769f,0x176a0,0x17691,0x1769f,0x17699,0x1769f,0x1769b,0x17694,0x17693,0x176cb,0x176a2,0x17699,0x1769c,0x17698,0x17695,0x1768e,0x17692,0x17694,0x17695,0x1768d,0x1768c,0x17686,0x1768b,0x1768a,0x17699,0x17698,0x1769d,0x17696,0x176a9,0x17690,0x17689,0x17683,0x17685,0x17676,0x17670,0x1766a,0x17673,0x17653,0x17656,0x1764d,0x1763c,0x1763a,0x1763c,0x1763a,0x17640,0x17637,0x1764e,0x17638,0x17634,0x17639,0x17640,0x17638,0x17639,0x17652,0x1764b,0x17652,0x17652,0x17650,0x17651,0x17644,0x1764f,0x17640,0x17634,0x17642,0x1763f,0x1763a,0x1763a,0x17641,0x17636,0x17635,0x1763a,0x1762f,0x1763a,0x1762e,0x17636,0x1762f,0x17623};
uint32_t aun_red_buffer11[500]={0x1fe40,0x1fe4f,0x1fe51,0x1fe4e,0x1fe5f,0x1fe58,0x1fe63,0x1fe5c,0x1fe55,0x1fe56,0x1fe60,0x1fe66,0x1fe5e,0x1fe63,0x1fe64,0x1fe65,0x1fe57,0x1fe65,0x1fe6a,0x1fe6a,0x1fe60,0x1fe7c,0x1fe67,0x1fe69,0x1fe61,0x1fe76,0x1fe71,0x1fe6b,0x1fe68,0x1fe77,0x1fe77,0x1fe6a,0xe70,0xe84,0xeb1,0xecc,0xef2,0xf05,0xefe,0xeef,0xed7,0xebf,0xe9d,0xe8e,0xe8d,0xe80,0xe69,0xe53,0xe2c,0xe27,0xe22,0xe2f,0xe32,0xe39,0xe3d,0xe33,0xe35,0xe36,0xe27,0xe25,0xe36,0xe47,0xe70,0xe83,0xe96,0xeb3,0xedc,0xf0a,0xf3f,0xf62,0xf8b,0xfa4,0xfbb,0x100a,0x1040,0x108a,0x10d1,0x1104,0x1146,0x118d,0x11b7,0x11ed,0x1222,0x125f,0x128d,0x12a7,0x12b8,0x12e5,0x1314,0x133e,0x135b,0x1393,0x13ea,0x1447,0x1499,0x14e5,0x1515,0x1527,0x152f,0x154a,0x155d,0x157e,0x1597,0x158e,0x15a7,0x15c7,0x1606,0x1640,0x1698,0x16e2,0x1707,0x1733,0x1742,0x177a,0x17d2,0x182a,0x1879,0x18af,0x18d2,0x1909,0x1907,0x18d6,0x1826,0x17a8,0x1753,0x1869,0x1a93,0x1cee,0x1f7e,0x226c,0x2546,0x28f6,0x85f,0x8e7,0x98c,0xa6e,0xb91,0xcf3,0xe88,0x1049,0x1225,0x1437,0x16a7,0x19af,0x1cff,0x20db,0x256e,0x2af2,0x31ff,0x3af7,0x4624,0x5366,0x625d,0x72db,0x84f2,0x9963,0xb152,0xcd4a,0xeeac,0x11681,0x144bf,0x17897,0x1a1f7,0x1e2de,0x21a47,0x23e14,0x2401e,0x20b22,0x1f559,0x1f516,0x1f392,0x1f340,0x1f350,0x1f330,0x1f2d8,0x1f2b0,0x1f27f,0x1f1dc,0x1f102,0x1f050,0x1f00a,0x1f023,0x1f025,0x1efd9,0x1ef85,0x1ef39,0x1eee9,0x1eeb1,0x1ee99,0x1eee6,0x1ef2b,0x1ef70,0x1efb9,0x1efeb,0x1f012,0x1f030,0x1f042,0x1f043,0x1f031,0x1f014,0x1efff,0x1f002,0x1eff7,0x1f00a,0x1f022,0x1f058,0x1f06a,0x1f0a1,0x1f0b5,0x1f0cb,0x1f0dc,0x1f0fb,0x1f10b,0x1f0f4,0x1f0fb,0x1f0fb,0x1f0ec,0x1f0d5,0x1f0e0,0x1f0ea,0x1f0ec,0x1f117,0x1f142,0x1f191,0x1f1b7,0x1f1f2,0x1f202,0x1f232,0x1f24c,0x1f265,0x1f270,0x1f295,0x1f56f,0x1f568,0x1f56a,0x1f56c,0x1f56c,0x1f573,0x1f570,0x1f570,0x1f568,0x1f567,0x1f569,0x1f56a,0x1f571,0x1f578,0x1f56e,0x1f580,0x1f571,0x1f581,0x1f57e,0x1f579,0x1f56a,0x1f560,0x1f55c,0x1f555,0x1f547,0x1f539,0x1f542,0x1f542,0x1f540,0x1f540,0x1f53f,0x1f54b,0x1f553,0x1f54c,0x1f549,0x1f54f,0x1f552,0x1f541,0x1f549,0x1f54d,0x1f559,0x1f564,0x1f551,0x1f551,0x1f55c,0x1f55b,0x1f55a,0x1f552,0x1f567,0x1f54f,0x1f554,0x1f54d,0x1f555,0x1f547,0x1f55d,0x1f560,0x1f557,0x1f560,0x1f569,0x1f56d,0x1f55b,0x1f563,0x1f584,0x1f56f,0x1f57b,0x1f581,0x1f56b,0x1f579,0x1f57b,0x1f57e,0x1f57a,0x1f58a,0x1f592,0x1f58a,0x1f59d,0x1f596,0x1f594,0x1f58b,0x1f58d,0x1f589,0x1f598,0x1f591,0x1f5ab,0x1f5a1,0x1f5b2,0x1f59d,0x1f597,0x1f59f,0x1f5ad,0x1f597,0x1f5ab,0x1f5b0,0x1f5b6,0x1f5bd,0x1f5b1,0x1f5c5,0x1f5c0,0x1f5bc,0x1f5b7,0x1f5b8,0x1f645,0x1f64c,0x1f64b,0x1f656,0x1f65b,0x1f658,0x1f663,0x1f657,0x1f650,0x1f665,0x1f65c,0x1f652,0x1f656,0x1f65c,0x1f667,0x1f65c,0x1f671,0x1f66e,0x1f672,0x1f671,0x1f673,0x1f669,0x1f66b,0x1f67f,0x1f677,0x1f682,0x1f691,0x1f690,0x1f685,0x1f67d,0x1f6a0,0x1f697,0x1f699,0x1f6a7,0x1f6a7,0x1f6ad,0x1f6a1,0x1f6a9,0x1f6ab,0x1f6af,0x1f6b6,0x1f6ad,0x1f6b2,0x1f6ad,0x1f6af,0x1f6b8,0x1f6c6,0x1f6b4,0x1f6c0,0x1f6c3,0x1f6be,0x1f6c5,0x1f6cc,0x1f6c1,0x1f6c9,0x1f6cb,0x1f6d6,0x1f6d1,0x1f6d2,0x1f6e9,0x1f6e0,0x1f6d4,0x1f6e5,0x1f6e7,0x1f6ef,0x1f6dc,0x1f6ec,0x1f6d6,0x1f6ce,0x1f6c9,0x1f6c5,0x1f6b0,0x1f6a7,0x1f6b8,0x1f6b7,0x1f6b9,0x1f6a6,0x1f6a7,0x1f6af,0x1f6a2,0x1f6ac,0x1f6a7,0x1f6b5,0x1f6b9,0x1f6ac,0x1f6ae,0x1f6a2,0x1f6ba,0x1f6bc,0x1f6cd,0x1f6ce,0x1f6dc,0x1f6c8,0x1f6e3,0x1f6d7,0x1f6c7,0x1f6df,0x1f6e3,0x1f6d4,0x1f6e1,0x1f6f9,0x1f740,0x1f747,0x1f744,0x1f751,0x1f752,0x1f757,0x1f768,0x1f772,0x1f759,0x1f763,0x1f76c,0x1f76b,0x1f77c,0x1f76d,0x1f77d,0x1f786,0x1f784,0x1f787,0x1f791,0x1f78e,0x1f786,0x1f76a,0x1f763,0x1f761,0x1f744,0x1f746,0x1f732,0x1f72c,0x1f732,0x1f721,0x1f719,0x1f716,0x1f722,0x1f71c,0x1f71b,0x1f70f,0x1f70f,0x1f711,0x1f716,0x1f721,0x1f723,0x1f71a,0x1f721,0x1f726,0x1f741,0x1f73d,0x1f72e,0x1f72c,0x1f741,0x1f747,0x1f741,0x1f731,0x1f724,0x1f73a,0x1f737,0x1f72a,0x1f722,0x1f738,0x1f749,0x1f735,0x1f73a,0x1f741,0x1f74c,0x1f736,0x1f73e,0x1f73a,0x1f74c};



static void *heartrateTask(const char *arg)
{ 
	(void)arg;

	while(1)
	{
	for(i=0;i<500;i++)
    {    
     aun_ir_buffer[i]=aun_ir_buffer11[i];
     aun_red_buffer[i]=aun_red_buffer11[i];
	 }
	//  for(i=0;i<500;i++){
	// 		printf("0x%02x,",aun_ir_buffer[i]);  
	// 	}
	// 	printf("\r\n");  
	// 	printf("--------0-0-----\r\n");
    //     for(i=0;i<500;i++){
	// 		printf("0x%02x,",aun_red_buffer[i]);  
	// 	}
	// 	printf("\r\n");  
	// 	printf("--------0-0-----\r\n");

        maxim_heart_rate_and_oxygen_saturation(aun_ir_buffer, n_ir_buffer_length, aun_red_buffer, &n_sp02, &ch_spo2_valid, &n_heart_rate, &ch_hr_valid);
		printf("HR=%i, \r\n", n_heart_rate); 
		printf("HRvalid=%i,\r\n ", ch_hr_valid);
		printf("SpO2=%i,\r\n ", n_sp02);
		printf("SPO2Valid=%i\r\n", ch_spo2_valid);		

	}
	return NULL;
}


static void HeartrateDemo(void)
{
    osThreadAttr_t attr;

	IoTWatchDogDisable();

    attr.name = "heartrateTask";
    attr.attr_bits = 0U;
    attr.cb_mem = NULL;
    attr.cb_size = 0U;
    attr.stack_mem = NULL;
    attr.stack_size = 4096;
    attr.priority = osPriorityNormal;

    if (osThreadNew((osThreadFunc_t)heartrateTask, NULL, &attr) == NULL) {
        printf("[HeartrateDemo] Falied to create heartrateTask!\n");
    }
    printf("\r\n[HeartrateDemo] Succ to create heartrateTask!\n");
}

 SYS_RUN(HeartrateDemo);
